# チケット #21: 投稿作成フロー

> Phase 2 メイン機能
> 優先度: 最高
> 参照: SPEC-PHASE2.md セクション 7.3

---

## 概要

Phase 2 の新しい投稿作成フローを実装する。
投稿タイプ選択 → 内容入力 → 画像設定 → 生成実行 → 結果確認の一連のステップを構築する。

---

## フロー概要

```
Step 1: 投稿タイプ選択
    ↓
Step 2: 内容入力（メモ書き or URL）
    ↓
Step 3: 画像設定（スタイル・アスペクト比・キャラクター）
    ↓
Step 4: 生成実行（文章 + 画像）
    ↓
Step 5: 結果確認・編集・ダウンロード
```

---

## タスク一覧

### 1. 投稿作成ページ構造
- [x] `/app/(dashboard)/create/page.tsx` - メインページ（ステップ管理）
- [x] ステップ状態管理（useState or URL params）
- [x] 進行状況インジケーター

### 2. Step 1: 投稿タイプ選択
- [x] `components/create/step-post-type.tsx` 作成
- [x] 4タイプのカード表示
  ```
  🔧 解決タイプ    📢 宣伝タイプ
  💡 Tipsタイプ    ✨ 実績タイプ
  ```
- [x] タイプ選択で次のステップへ

### 3. Step 2: 内容入力
- [x] `components/create/step-content-input.tsx` 作成
- [x] メモ書き入力エリア
  - プレースホルダーにタイプ別の例文
  - 文字数カウント
- [x] URL 入力オプション（記事抽出）
- [x] 入力バリデーション（20文字以上）
- [x] 前のステップに戻るボタン

### 4. Step 3: 画像設定
- [x] `components/create/step-image-settings.tsx` 作成
- [x] 画像スタイル選択
  ```
  ○ マンガ風（男性）  ○ マンガ風（女性）
  ○ ピクセルアート    ○ イラスト（人物なし）
  ```
- [x] アスペクト比選択
  ```
  ○ 1:1（フィード投稿）  ○ 9:16（リール/ストーリー）
  ```
- [x] キャラクター選択（任意）
  - 登録済みキャラクター一覧
  - 「キャラクターなし」オプション
- [x] プレビュー表示（選択内容の確認）

### 5. Step 4: 生成実行
- [x] `components/create/step-generating.tsx` 作成
- [x] 生成中のローディング表示
- [x] 進捗ステータス
  ```
  ✅ 文章を生成中... → 完了
  🔄 画像を生成中... → 進行中
  ⏳ 保存中...
  ```
- [x] 生成処理の実行
  1. `/api/generate/caption` 呼び出し
  2. `/api/generate/scene` 呼び出し（シーン説明生成）
  3. `/api/generate/image` 呼び出し
  4. 投稿保存（#20で実装予定）

### 6. Step 5: 結果確認
- [x] `components/create/step-result.tsx` 作成
- [x] または `/app/(dashboard)/create/result/page.tsx`
- [x] 表示項目
  - 生成された投稿文（編集可能）
  - ハッシュタグ（選択・追加可能）
  - 生成された画像
- [x] アクション
  - 投稿文をコピー
  - ハッシュタグをコピー
  - 画像をダウンロード
  - Instagram を開く
  - 画像を再生成
  - 新規作成に戻る

### 7. 状態管理
- [x] 作成フォームの状態型定義
  ```typescript
  interface CreateFormState {
    postType: PostType | null;
    inputText: string;
    sourceUrl: string;
    imageStyle: ImageStyle;
    aspectRatio: AspectRatio;
    characterId: string | null;
  }
  ```
- [x] ステップ間のデータ引き継ぎ
- [x] ブラウザバック対応

### 8. Phase 1 コードとの統合
- [x] 既存の `/generate` ページとの関係整理（並行稼働）
- [x] Phase 1 機能の維持 or 移行
- [x] 共通コンポーネントの再利用

### 9. エラーハンドリング
- [x] 各ステップでのバリデーションエラー
- [x] API エラー時のリトライ
- [x] ネットワークエラー表示

### 10. レスポンシブ対応
- [x] モバイルでのステップ表示
- [x] タッチ操作への最適化

---

## UI 設計

### Step 1: 投稿タイプ選択
```
┌─────────────────────────────────────────────┐
│  新規投稿作成                                │
│  ─────────────────────────────────────────  │
│  ● タイプ選択 → 内容入力 → 画像設定 → 生成   │
├─────────────────────────────────────────────┤
│                                             │
│  どんな投稿を作りますか？                     │
│                                             │
│  ┌─────────────┐  ┌─────────────┐          │
│  │     🔧      │  │     📢      │          │
│  │ 解決タイプ   │  │ 宣伝タイプ   │          │
│  │ シニア向け   │  │ビジネス向け  │          │
│  └─────────────┘  └─────────────┘          │
│                                             │
│  ┌─────────────┐  ┌─────────────┐          │
│  │     💡      │  │     ✨      │          │
│  │ Tipsタイプ  │  │ 実績タイプ   │          │
│  │ビジネス向け  │  │ビジネス向け  │          │
│  └─────────────┘  └─────────────┘          │
│                                             │
└─────────────────────────────────────────────┘
```

### Step 2: 内容入力
```
┌─────────────────────────────────────────────┐
│  新規投稿作成                                │
│  ─────────────────────────────────────────  │
│  ✓ タイプ選択 → ● 内容入力 → 画像設定 → 生成 │
├─────────────────────────────────────────────┤
│                                             │
│  🔧 解決タイプ を選択しました                 │
│                                             │
│  投稿したい内容をメモ書きで入力してください      │
│  ┌─────────────────────────────────────┐   │
│  │ LINEの通知が来ないって質問されて、     │   │
│  │ 設定から通知をONにしたら解決した。     │   │
│  │ 結構この質問多いんだよね。            │   │
│  └─────────────────────────────────────┘   │
│  125 / 10000 文字                           │
│                                             │
│  または記事URLを入力:                        │
│  ┌─────────────────────────────────────┐   │
│  │ https://...                         │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  [← 戻る]                    [次へ →]       │
└─────────────────────────────────────────────┘
```

### Step 3: 画像設定
```
┌─────────────────────────────────────────────┐
│  新規投稿作成                                │
│  ─────────────────────────────────────────  │
│  ✓ タイプ選択 → ✓ 内容入力 → ● 画像設定 → 生成│
├─────────────────────────────────────────────┤
│                                             │
│  画像スタイルを選択                          │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐│
│  │[preview]│ │[preview]│ │[preview]│ │[preview]││
│  │マンガ男性│ │マンガ女性│ │ピクセル │ │イラスト ││
│  │   ●    │ │   ○    │ │   ○   │ │   ○   ││
│  └────────┘ └────────┘ └────────┘ └────────┘│
│                                             │
│  アスペクト比                                │
│  ● 1:1（フィード）  ○ 9:16（リール）          │
│                                             │
│  キャラクター（任意）                         │
│  ○ なし  ● まさゆき  ○ サポートキャラ        │
│                                             │
│  [← 戻る]                [生成する →]        │
└─────────────────────────────────────────────┘
```

### Step 4: 生成中
```
┌─────────────────────────────────────────────┐
│  新規投稿作成                                │
│  ─────────────────────────────────────────  │
│  ✓ タイプ選択 → ✓ 内容入力 → ✓ 画像設定 → ● 生成│
├─────────────────────────────────────────────┤
│                                             │
│            🔄 生成中...                      │
│                                             │
│     ✅ 投稿文を生成しました                   │
│     🔄 画像を生成しています...                │
│     ⏳ 保存中...                             │
│                                             │
│     ████████████░░░░░░░░ 60%                │
│                                             │
│     ※ 画像生成には最大30秒かかります          │
│                                             │
└─────────────────────────────────────────────┘
```

---

## 完了条件

- [x] 5ステップの投稿作成フローが動作する
- [x] 投稿タイプが選択できる
- [x] メモ書き/URL での入力ができる
- [x] 画像設定が選択できる
- [x] 文章と画像が生成される
- [x] 結果の確認・編集・ダウンロードができる
- [ ] 投稿が履歴に保存される（#20で実装予定）
- [x] レスポンシブ対応されている

---

## 技術メモ

### ステップ管理
```typescript
const [step, setStep] = useState<1 | 2 | 3 | 4 | 5>(1);

// または URL ベース
// /create?step=1
// /create?step=2&type=solution
```

### フォーム状態の永続化
- sessionStorage でステップ間のデータを保持
- ブラウザリロード時の復元

---

## 依存関係

- #15 ダッシュボード・レイアウト
- #16 投稿タイプ・テンプレート
- #17 Gemini 文章生成
- #18 キャラクター管理
- #19 Gemini 画像生成
- #20 投稿履歴管理

## 後続タスク

- #22 Phase 2 統合テスト
