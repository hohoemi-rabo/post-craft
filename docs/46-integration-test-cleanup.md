# チケット #46: 統合テスト・クリーンアップ

> Phase 3 Revised | 優先度: 高 | 依存: #38, #39, #40, #41, #42, #43, #44, #45

## 概要

Phase 3 Revised の全機能を通しでテストし、不具合の修正とコードのクリーンアップを行う。既存データの保全、後方互換性、全フローの動作を検証する。ドキュメントを最新化する。

## 対象ファイル

| ファイル | 操作 |
|---------|------|
| 全変更ファイル | テスト・修正 |
| `docs/SPEC-CURRENT.md` | 更新（Phase 3 Revised の内容を反映） |
| `CLAUDE.md` | 更新（Phase 3 Revised の内容を反映） |
| `.claude/rules/backend.md` | 更新（新API・新カラムを反映） |
| `.claude/rules/ai.md` | 更新（DBプロンプト使用を反映） |

## テスト項目

### 1. システムプロンプト関連

| テスト | 確認内容 |
|--------|---------|
| メモ書きからのAI生成 | メモ入力→「AIで生成」→プロンプトが生成される |
| 手動編集 | 生成後にプロンプトを編集→保存→反映される |
| 初期値表示 | 初回アクセス時にデフォルトSYSTEM_PROMPTが表示される |
| キャプション生成への反映 | 設定したシステムプロンプトがキャプション生成に使用される |

### 2. 投稿タイプ登録・編集

| テスト | 確認内容 |
|--------|---------|
| 新規作成（fields） | メモ書き→AI生成→プレビュー→保存が動作する |
| 新規作成（memo） | メモ書き→AI生成→プレビュー→保存（placeholders空）が動作する |
| 既存タイプ編集 | メモ再入力→再生成→保存が動作する |
| ビルトイン7タイプ編集 | ビルトインタイプの編集が正常に動作する |
| プレビューモーダル | タイプ別プロンプト・テンプレート・入力項目・サンプル投稿が表示される |

### 3. 投稿作成フロー

| テスト | 確認内容 |
|--------|---------|
| fields モード入力 | プレースホルダーフォームが表示され入力できる |
| memo モード入力 | テキストエリアが表示され入力できる |
| ビルトインタイプ生成 | 既存7タイプで正常にキャプション生成される |
| カスタムタイプ生成 | 新規作成したカスタムタイプで正常に生成される |

### 4. 既存データの保全

| テスト | 確認内容 |
|--------|---------|
| 投稿履歴の表示 | 既存の投稿履歴が正常に表示される |
| 投稿タイプの維持 | ビルトイン7タイプが正しく存在する |
| 後方互換性 | slug指定でのキャプション生成が動作する |

### 5. エッジケース

| テスト | 確認内容 |
|--------|---------|
| system_prompt=NULL | デフォルトSYSTEM_PROMPTにフォールバック |
| type_prompt=NULL | buildCustomTypePrompt()にフォールバック |
| 関連投稿参照 + カスタムタイプ | 関連投稿参照が正しく動作する |
| image_read タイプ | 画像読み取りタイプが影響なく動作する |

## クリーンアップ

- 不要になったコメントの削除
- 開発用 console.log の削除
- TypeScript の型エラーがないことを確認
- 不要な import の整理

## 受入条件

- 上記全テストが合格する
- `npm run build` が成功する
- `npm run lint` が成功する
- 既存の投稿履歴データに変更がない
- ドキュメントが最新化されている

## TODO

- [x] システムプロンプト関連テスト（4項目）
- [x] 投稿タイプ登録・編集テスト（5項目）
- [x] 投稿作成フローテスト（4項目）
- [x] 既存データ保全テスト（3項目）
- [x] エッジケーステスト（4項目）
- [x] コードクリーンアップ
- [x] `npm run build` 成功確認
- [x] `npm run lint` 成功確認
- [ ] `docs/SPEC-CURRENT.md` 更新
- [ ] `CLAUDE.md` 更新
- [ ] `.claude/rules/backend.md` 更新
- [ ] `.claude/rules/ai.md` 更新
