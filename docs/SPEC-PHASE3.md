# Post Craft フェーズ3 要件定義書

> 作成日: 2026-02-09
> ステータス: 要件定義完了
> フェーズ: Phase 3（自分ブランドのカスタマイズ機能）

---

## 1. プロジェクト概要

### 1.1 フェーズ3の目標

現在ハードコードされている投稿タイプ・必須ハッシュタグをDB管理に移行し、まさゆきさん自身が「自分ブランド」の投稿素材を自由にカスタマイズできるようにする。

### 1.2 フェーズ全体の位置づけ

| フェーズ    | 内容                                                                   | 状態    |
| ----------- | ---------------------------------------------------------------------- | ------- |
| Phase 2     | 基本機能（投稿タイプ7種、画像生成5種、キャラクター、Instagram投稿等）  | ✅ 完了 |
| **Phase 3** | **自分ブランドのカスタマイズ**（投稿タイプ編集、必須ハッシュタグ設定） | 🎯 今回 |
| Phase 4     | 複数ユーザー対応（ユーザーごとのカスタマイズ）                         | 将来    |

### 1.3 フェーズ3の設計方針

- **Phase 4への拡張を意識した設計**: 現在ハードコードされている設定をDBテーブル化し、`user_id`カラムを含める
- **既存データの保全**: 投稿履歴は絶対に残す。慎重なデータ移行を行う
- **段階的な実装**: 画像スタイルのカスタマイズは今回実装しない（運用しながら将来検討）

---

## 2. 実装範囲

### 2.1 実装する機能

| #   | 機能                   | 優先度 | 説明                                   |
| --- | ---------------------- | ------ | -------------------------------------- |
| 1   | 投稿タイプ管理（CRUD） | 高     | 投稿タイプの作成・編集・削除・並び替え |
| 2   | 投稿タイプのDB移行     | 高     | 既存7タイプをDBテーブルに移行          |
| 3   | 必須ハッシュタグ設定   | 高     | 最大4個まで設定、生成数を自動調整      |
| 4   | 設定専用ページ         | 高     | 使いやすい設定UIの新規作成             |
| 5   | 既存データ移行         | 高     | 投稿履歴の投稿タイプ参照をDB IDに移行  |

### 2.2 実装しない機能（将来検討）

| 機能                           | 理由                                     |
| ------------------------------ | ---------------------------------------- |
| 画像スタイルのカスタマイズ     | 運用しながら将来的に検討                 |
| ブランド情報設定               | 低優先度、今回は見送り                   |
| 投稿タイプ別の推奨ハッシュタグ | 必要なし（全体の必須ハッシュタグで対応） |

---

## 3. 投稿タイプ管理機能

### 3.1 概要

現在コード内にハードコードされている7種類の投稿タイプをDBテーブルに移行し、CRUD操作を可能にする。

### 3.2 現在の投稿タイプ（移行対象）

| ID           | タイプ名          | 説明                              |
| ------------ | ----------------- | --------------------------------- |
| `solution`   | 🔧 解決タイプ     | よくある質問と3ステップの解決方法 |
| `promotion`  | 📢 宣伝タイプ     | サービスの価値と3つの悩み解決     |
| `tips`       | 💡 AI活用タイプ   | AIの便利な使い方と3つのメリット   |
| `showcase`   | ✨ 実績タイプ     | 課題→解決策→成果の紹介            |
| `useful`     | 📚 お役立ちタイプ | 汎用的な便利情報と3つのメリット   |
| `howto`      | 📖 使い方タイプ   | 便利情報＋3ステップの操作手順     |
| `image_read` | 🖼️ 画像読み取り   | 画像をAIで分析し投稿文を自動生成  |

### 3.3 編集可能項目

| 項目                 | 説明                                                      | 必須 | 制限                |
| -------------------- | --------------------------------------------------------- | :--: | ------------------- |
| タイプ名             | 表示名（例：「🔧 解決タイプ」）                           |  ✅  | 50文字以内          |
| 説明文               | タイプの説明（例：「よくある質問と3ステップの解決方法」） |  ✅  | 200文字以内         |
| アイコン/絵文字      | タイプを表す絵文字                                        |  ✅  | 絵文字1個（選択式） |
| テンプレート構造     | キャプション生成のベーステンプレート                      |  ✅  | 2000文字以内        |
| プレースホルダー変数 | テンプレート内の変数定義                                  |  ✅  | 最大10個            |
| 文字数目安           | 生成する文章の目安文字数                                  |  ✅  | 最小/最大を設定     |
| 並び順               | 投稿タイプ選択画面での表示順                              |  ✅  | 数値                |
| 有効/無効            | 投稿作成時に選択肢として表示するか                        |  ✅  | boolean             |

### 3.4 投稿タイプの上限

- **最大10個**まで作成可能
- 既存7タイプを含む（削除すれば新規作成可能）

### 3.5 プレースホルダー変数の仕様

#### 変数の定義

| 項目       | 説明                           | 例                                  |
| ---------- | ------------------------------ | ----------------------------------- |
| 変数名     | テンプレート内で使用する識別子 | `question`, `step1`                 |
| 表示ラベル | 入力フォームに表示する名前     | 「質問内容」「ステップ1」           |
| 説明       | 入力のヒント                   | 「シニアからの質問を入力」          |
| 必須フラグ | 入力必須かどうか               | true / false                        |
| 入力タイプ | 入力UIの種類                   | `text`（1行）/ `textarea`（複数行） |

#### テンプレート内での使用

```
📱 シニアからの質問
「{question}」

💡 解決方法
① {step1}
② {step2}
③ {step3}

✨ ワンポイント
{tip}

---
📍パソコン・スマホ ほほ笑みラボ（飯田市）
```

### 3.6 テンプレート編集UI（ハイブリッド方式）

#### 基本構造（フォーム部分）

| 項目       | 入力方法               |
| ---------- | ---------------------- |
| タイプ名   | テキスト入力           |
| 説明文     | テキスト入力           |
| アイコン   | 絵文字ピッカーから選択 |
| 文字数目安 | 数値入力（最小/最大）  |

#### プレースホルダー変数（フォーム部分）

変数を追加・編集・削除・並び替えできるリスト形式のUI

```
┌─────────────────────────────────────────────┐
│ プレースホルダー変数                          │
├─────────────────────────────────────────────┤
│ ≡ {question}  質問内容     [必須] [編集][削除]│
│ ≡ {step1}     ステップ1    [必須] [編集][削除]│
│ ≡ {step2}     ステップ2    [必須] [編集][削除]│
│ ≡ {step3}     ステップ3    [必須] [編集][削除]│
│ ≡ {tip}       ワンポイント [任意] [編集][削除]│
│                                             │
│ [+ 変数を追加]                               │
└─────────────────────────────────────────────┘
```

#### テンプレート構造（テキスト編集部分）

```
┌─────────────────────────────────────────────┐
│ テンプレート構造                             │
├─────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────┐ │
│ │📱 シニアからの質問                       │ │
│ │「{question}」                           │ │
│ │                                         │ │
│ │💡 解決方法                              │ │
│ │① {step1}                               │ │
│ │② {step2}                               │ │
│ │③ {step3}                               │ │
│ │                                         │ │
│ │✨ ワンポイント                          │ │
│ │{tip}                                    │ │
│ │                                         │ │
│ │---                                      │ │
│ │📍パソコン・スマホ ほほ笑みラボ（飯田市）  │ │
│ └─────────────────────────────────────────┘ │
│                                             │
│ 💡 {変数名} の形式でプレースホルダーを挿入    │
│ 💡 利用可能: {question}, {step1}, {step2}... │
└─────────────────────────────────────────────┘
```

### 3.7 投稿タイプ一覧画面

```
┌─────────────────────────────────────────────┐
│ 📝 投稿タイプ管理                    [+ 新規作成] │
├─────────────────────────────────────────────┤
│                                             │
│ ≡ 🔧 解決タイプ                             │
│   よくある質問と3ステップの解決方法          │
│   [編集] [複製] [削除]              [有効 ✓] │
│                                             │
│ ≡ 📢 宣伝タイプ                             │
│   サービスの価値と3つの悩み解決              │
│   [編集] [複製] [削除]              [有効 ✓] │
│                                             │
│ ≡ 💡 AI活用タイプ                           │
│   AIの便利な使い方と3つのメリット            │
│   [編集] [複製] [削除]              [有効 ✓] │
│                                             │
│ ... 他のタイプ ...                          │
│                                             │
│ 📊 7 / 10 タイプ使用中                       │
└─────────────────────────────────────────────┘
```

### 3.8 投稿タイプの操作

| 操作      | 説明                                             |
| --------- | ------------------------------------------------ |
| 作成      | 新規投稿タイプを作成（上限10個まで）             |
| 編集      | 既存投稿タイプの内容を編集                       |
| 複製      | 既存投稿タイプをコピーして新規作成               |
| 削除      | 投稿タイプを削除（使用中の投稿がある場合は警告） |
| 並び替え  | ドラッグ&ドロップで表示順を変更                  |
| 有効/無効 | 投稿作成時の選択肢に表示/非表示                  |

### 3.9 削除時の挙動

投稿タイプを削除する際、そのタイプを使用している投稿が存在する場合：

| パターン         | 挙動                                     |
| ---------------- | ---------------------------------------- |
| 使用中の投稿あり | 警告を表示し、確認後に削除可能           |
| 削除後の投稿     | 投稿の`post_type_id`は残る（orphan状態） |
| 履歴表示         | 「削除されたタイプ」として表示           |

---

## 4. 必須ハッシュタグ設定機能

### 4.1 概要

現在コード内にハードコードされている必須ハッシュタグ（4個）を設定画面から編集可能にする。

### 4.2 現在の必須ハッシュタグ

```
#ほほ笑みラボ #飯田市 #パソコン教室 #スマホ
```

### 4.3 仕様

| 項目                   | 仕様                          |
| ---------------------- | ----------------------------- |
| 必須ハッシュタグ数     | 最小0個〜最大4個              |
| 自動生成ハッシュタグ数 | 10 - 必須ハッシュタグ数       |
| 合計ハッシュタグ数     | 常に10個を維持                |
| 保存場所               | DBテーブル（`user_settings`） |

### 4.4 ハッシュタグ生成ロジック

| 必須数 | 生成数 | 合計 |
| :----: | :----: | :--: |
|  0個   |  10個  | 10個 |
|  1個   |  9個   | 10個 |
|  2個   |  8個   | 10個 |
|  3個   |  7個   | 10個 |
|  4個   |  6個   | 10個 |

### 4.5 設定UI

```
┌─────────────────────────────────────────────┐
│ #️⃣ 必須ハッシュタグ設定                      │
├─────────────────────────────────────────────┤
│                                             │
│ 毎回の投稿に必ず含めるハッシュタグを設定      │
│ （最大4個まで）                              │
│                                             │
│ ┌─────────────────────────────────────────┐ │
│ │ #ほほ笑みラボ                    [× 削除]│ │
│ │ #飯田市                          [× 削除]│ │
│ │ #パソコン教室                    [× 削除]│ │
│ │ #スマホ                          [× 削除]│ │
│ └─────────────────────────────────────────┘ │
│                                             │
│ [+ ハッシュタグを追加] (残り0個)             │
│                                             │
│ 💡 残り6個のハッシュタグはAIが自動生成します  │
│                                             │
│ [保存]                                      │
└─────────────────────────────────────────────┘
```

---

## 5. データベース設計

### 5.1 新規テーブル

#### post_types テーブル

投稿タイプの定義を保存するテーブル。

```sql
CREATE TABLE post_types (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL,

  -- 基本情報
  name TEXT NOT NULL,                    -- タイプ名（例：「🔧 解決タイプ」）
  slug TEXT NOT NULL,                    -- 識別子（例：「solution」）
  description TEXT,                      -- 説明文
  icon TEXT NOT NULL DEFAULT '📝',       -- 絵文字アイコン

  -- テンプレート
  template_structure TEXT NOT NULL,      -- テンプレート構造
  placeholders JSONB NOT NULL DEFAULT '[]', -- プレースホルダー変数の配列

  -- 文字数設定
  min_length INTEGER DEFAULT 200,        -- 最小文字数
  max_length INTEGER DEFAULT 400,        -- 最大文字数

  -- 表示設定
  sort_order INTEGER NOT NULL DEFAULT 0, -- 並び順
  is_active BOOLEAN NOT NULL DEFAULT true, -- 有効/無効

  -- メタデータ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  -- 制約
  UNIQUE(user_id, slug)
);

-- インデックス
CREATE INDEX idx_post_types_user_id ON post_types(user_id);
CREATE INDEX idx_post_types_sort_order ON post_types(user_id, sort_order);
```

#### placeholders JSONB の構造

```json
[
  {
    "name": "question",
    "label": "質問内容",
    "description": "シニアからの質問を入力",
    "required": true,
    "inputType": "text"
  },
  {
    "name": "step1",
    "label": "ステップ1",
    "description": "解決方法の1つ目",
    "required": true,
    "inputType": "text"
  },
  {
    "name": "step2",
    "label": "ステップ2",
    "description": "解決方法の2つ目",
    "required": true,
    "inputType": "text"
  },
  {
    "name": "step3",
    "label": "ステップ3",
    "description": "解決方法の3つ目",
    "required": true,
    "inputType": "text"
  },
  {
    "name": "tip",
    "label": "ワンポイント",
    "description": "追加のアドバイス（任意）",
    "required": false,
    "inputType": "textarea"
  }
]
```

#### user_settings テーブル

ユーザーごとの設定を保存するテーブル。

```sql
CREATE TABLE user_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT UNIQUE NOT NULL,

  -- 必須ハッシュタグ
  required_hashtags TEXT[] DEFAULT ARRAY[]::TEXT[],

  -- 将来の拡張用
  settings JSONB DEFAULT '{}',

  -- メタデータ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_user_settings_user_id ON user_settings(user_id);
```

### 5.2 既存テーブルの変更

#### posts テーブル

`post_type`カラム（TEXT型）に加えて、`post_type_id`カラム（UUID型、FK）を追加。

```sql
-- 新しいカラムを追加
ALTER TABLE posts
ADD COLUMN post_type_id UUID REFERENCES post_types(id) ON DELETE SET NULL;

-- インデックス追加
CREATE INDEX idx_posts_post_type_id ON posts(post_type_id);
```

**移行戦略:**

1. 新しい`post_type_id`カラムを追加（NULL許可）
2. 既存7タイプを`post_types`テーブルに挿入
3. 既存投稿の`post_type`（TEXT）を元に`post_type_id`を設定
4. 新規投稿は`post_type_id`を使用
5. `post_type`カラムは互換性のため残す（将来的に削除検討）

### 5.3 Row Level Security

```sql
-- post_types テーブル
ALTER TABLE post_types ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own post types"
  ON post_types FOR SELECT
  USING (auth.uid()::text = user_id);

CREATE POLICY "Users can insert their own post types"
  ON post_types FOR INSERT
  WITH CHECK (auth.uid()::text = user_id);

CREATE POLICY "Users can update their own post types"
  ON post_types FOR UPDATE
  USING (auth.uid()::text = user_id);

CREATE POLICY "Users can delete their own post types"
  ON post_types FOR DELETE
  USING (auth.uid()::text = user_id);

-- user_settings テーブル
ALTER TABLE user_settings ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own settings"
  ON user_settings FOR SELECT
  USING (auth.uid()::text = user_id);

CREATE POLICY "Users can insert their own settings"
  ON user_settings FOR INSERT
  WITH CHECK (auth.uid()::text = user_id);

CREATE POLICY "Users can update their own settings"
  ON user_settings FOR UPDATE
  USING (auth.uid()::text = user_id);
```

---

## 6. データ移行

### 6.1 移行の重要性

⚠️ **既存の投稿履歴は絶対に残す。慎重なデータ移行を行う。**

投稿履歴は今後の新機能実装に必要なため、データの整合性を維持しながら移行する。

### 6.2 移行手順

#### Step 1: バックアップ

```sql
-- 移行前にバックアップを作成
CREATE TABLE posts_backup AS SELECT * FROM posts;
```

#### Step 2: 新テーブル作成

`post_types`テーブルと`user_settings`テーブルを作成。

#### Step 3: 既存投稿タイプをDBに挿入

```sql
-- まさゆきさんのuser_idを使用
INSERT INTO post_types (user_id, name, slug, description, icon, template_structure, placeholders, min_length, max_length, sort_order, is_active)
VALUES
  ('USER_ID', '🔧 解決タイプ', 'solution', 'よくある質問と3ステップの解決方法', '🔧',
   E'📱 シニアからの質問\n「{question}」\n\n💡 解決方法\n① {step1}\n② {step2}\n③ {step3}\n\n✨ ワンポイント\n{tip}\n\n---\n📍パソコン・スマホ ほほ笑みラボ（飯田市）',
   '[{"name":"question","label":"質問内容","required":true,"inputType":"text"},{"name":"step1","label":"ステップ1","required":true,"inputType":"text"},{"name":"step2","label":"ステップ2","required":true,"inputType":"text"},{"name":"step3","label":"ステップ3","required":true,"inputType":"text"},{"name":"tip","label":"ワンポイント","required":false,"inputType":"textarea"}]'::jsonb,
   200, 300, 1, true),
  -- 他の6タイプも同様に挿入
  ...
;
```

#### Step 4: 既存投稿の post_type_id を設定

```sql
-- 既存投稿に post_type_id を設定
UPDATE posts p
SET post_type_id = pt.id
FROM post_types pt
WHERE p.post_type = pt.slug
  AND p.user_id = pt.user_id;
```

#### Step 5: 必須ハッシュタグを設定

```sql
INSERT INTO user_settings (user_id, required_hashtags)
VALUES ('USER_ID', ARRAY['#ほほ笑みラボ', '#飯田市', '#パソコン教室', '#スマホ']);
```

#### Step 6: 検証

```sql
-- 移行結果を検証
SELECT
  p.id,
  p.post_type,
  p.post_type_id,
  pt.name as post_type_name
FROM posts p
LEFT JOIN post_types pt ON p.post_type_id = pt.id
WHERE p.user_id = 'USER_ID';
```

### 6.3 ロールバック手順

万が一の場合に備えたロールバック手順。

```sql
-- post_type_id カラムを削除
ALTER TABLE posts DROP COLUMN post_type_id;

-- 新テーブルを削除
DROP TABLE IF EXISTS post_types;
DROP TABLE IF EXISTS user_settings;

-- バックアップから復元（必要な場合）
-- DROP TABLE posts;
-- ALTER TABLE posts_backup RENAME TO posts;
```

---

## 7. API設計

### 7.1 新規エンドポイント

#### 投稿タイプAPI

| メソッド | パス                             | 説明               |
| -------- | -------------------------------- | ------------------ |
| GET      | `/api/post-types`                | 投稿タイプ一覧取得 |
| POST     | `/api/post-types`                | 投稿タイプ新規作成 |
| GET      | `/api/post-types/[id]`           | 投稿タイプ詳細取得 |
| PUT      | `/api/post-types/[id]`           | 投稿タイプ更新     |
| DELETE   | `/api/post-types/[id]`           | 投稿タイプ削除     |
| POST     | `/api/post-types/[id]/duplicate` | 投稿タイプ複製     |
| PUT      | `/api/post-types/reorder`        | 投稿タイプ並び替え |

#### ユーザー設定API

| メソッド | パス                     | 説明                 |
| -------- | ------------------------ | -------------------- |
| GET      | `/api/settings`          | ユーザー設定取得     |
| PUT      | `/api/settings`          | ユーザー設定更新     |
| PUT      | `/api/settings/hashtags` | 必須ハッシュタグ更新 |

### 7.2 API仕様詳細

#### GET /api/post-types

投稿タイプ一覧を取得する。

**Response:**

```typescript
{
  postTypes: [
    {
      id: string;
      name: string;
      slug: string;
      description: string;
      icon: string;
      templateStructure: string;
      placeholders: Placeholder[];
      minLength: number;
      maxLength: number;
      sortOrder: number;
      isActive: boolean;
      createdAt: string;
      updatedAt: string;
    }
  ];
  count: number;
  maxCount: number; // 10
}
```

#### POST /api/post-types

新規投稿タイプを作成する。

**Request:**

```typescript
{
  name: string;
  slug?: string;          // 省略時は自動生成
  description?: string;
  icon: string;
  templateStructure: string;
  placeholders: Placeholder[];
  minLength?: number;     // デフォルト: 200
  maxLength?: number;     // デフォルト: 400
  isActive?: boolean;     // デフォルト: true
}
```

**Response:**

```typescript
{
  postType: PostType;
}
```

**エラー:**

- 400: バリデーションエラー
- 400: 上限（10個）に達している
- 409: slug が重複している

#### PUT /api/post-types/[id]

投稿タイプを更新する。

**Request:**

```typescript
{
  name?: string;
  description?: string;
  icon?: string;
  templateStructure?: string;
  placeholders?: Placeholder[];
  minLength?: number;
  maxLength?: number;
  isActive?: boolean;
}
```

#### DELETE /api/post-types/[id]

投稿タイプを削除する。

**Response:**

```typescript
{
  deleted: true;
  affectedPosts: number; // この投稿タイプを使用していた投稿数
}
```

#### PUT /api/settings/hashtags

必須ハッシュタグを更新する。

**Request:**

```typescript
{
  requiredHashtags: string[];  // 最大4個
}
```

**Response:**

```typescript
{
  requiredHashtags: string[];
  generatedCount: number;  // 10 - requiredHashtags.length
}
```

### 7.3 既存APIの変更

#### POST /api/generate/caption

リクエストに`postTypeId`を追加。DB から投稿タイプ情報を取得してキャプション生成に使用。

**Request（変更後）:**

```typescript
{
  postTypeId: string;       // 新規追加（必須）
  postType?: string;        // 後方互換性のため残す（非推奨）
  inputText: string;
  sourceUrl?: string;
  // ... 他のフィールド
}
```

#### GET /api/posts, GET /api/posts/[id]

レスポンスに`postType`オブジェクトを含める。

**Response（変更後）:**

```typescript
{
  id: string;
  postType: string;         // 後方互換性のため残す
  postTypeId: string;       // 新規追加
  postTypeData: {           // 新規追加（投稿タイプの詳細）
    id: string;
    name: string;
    icon: string;
    // ...
  } | null;                 // 削除された投稿タイプの場合はnull
  // ... 他のフィールド
}
```

---

## 8. 画面設計

### 8.1 新規画面一覧

| 画面             | パス                        | 説明                   |
| ---------------- | --------------------------- | ---------------------- |
| 投稿タイプ一覧   | `/settings/post-types`      | 投稿タイプの一覧・管理 |
| 投稿タイプ作成   | `/settings/post-types/new`  | 新規投稿タイプ作成     |
| 投稿タイプ編集   | `/settings/post-types/[id]` | 投稿タイプ編集         |
| ハッシュタグ設定 | `/settings/hashtags`        | 必須ハッシュタグ設定   |

### 8.2 サイドバーの変更

```
📊 ダッシュボード
📝 投稿作成
📚 履歴
👤 キャラクター
⚙️ 設定
   └─ 📝 投稿タイプ     ← 新規追加
   └─ #️⃣ ハッシュタグ   ← 新規追加
```

### 8.3 投稿タイプ一覧画面

```
┌─────────────────────────────────────────────────────────────┐
│ ⚙️ 設定 > 📝 投稿タイプ管理                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 投稿タイプを作成・編集して、あなただけの投稿テンプレートを    │
│ カスタマイズできます。                                       │
│                                                             │
│ ┌─────────────────────────────────────────────┐             │
│ │                                             │ [+ 新規作成]│
│ ├─────────────────────────────────────────────┤             │
│ │ ≡ 🔧 解決タイプ                     [有効]  │             │
│ │   よくある質問と3ステップの解決方法         │             │
│ │   200〜300文字 | 変数5個                    │             │
│ │                        [編集] [複製] [削除] │             │
│ ├─────────────────────────────────────────────┤             │
│ │ ≡ 📢 宣伝タイプ                     [有効]  │             │
│ │   サービスの価値と3つの悩み解決             │             │
│ │   200〜400文字 | 変数5個                    │             │
│ │                        [編集] [複製] [削除] │             │
│ ├─────────────────────────────────────────────┤             │
│ │ ... 他の投稿タイプ ...                      │             │
│ └─────────────────────────────────────────────┘             │
│                                                             │
│ 📊 7 / 10 タイプ使用中                                       │
│                                                             │
│ 💡 ドラッグ&ドロップで並び順を変更できます                    │
└─────────────────────────────────────────────────────────────┘
```

### 8.4 投稿タイプ編集画面

```
┌─────────────────────────────────────────────────────────────┐
│ ⚙️ 設定 > 📝 投稿タイプ > 🔧 解決タイプを編集                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ┌─ 基本情報 ──────────────────────────────────────────────┐ │
│ │                                                         │ │
│ │ アイコン        タイプ名                                 │ │
│ │ [🔧 ▼]         [解決タイプ________________]             │ │
│ │                                                         │ │
│ │ 説明文                                                  │ │
│ │ [よくある質問と3ステップの解決方法________]             │ │
│ │                                                         │ │
│ │ 文字数目安                                              │ │
│ │ 最小 [200] 〜 最大 [300] 文字                           │ │
│ │                                                         │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─ プレースホルダー変数 ──────────────────────────────────┐ │
│ │                                                         │ │
│ │ ≡ {question}  質問内容      [必須] [1行]    [編集][×]  │ │
│ │ ≡ {step1}     ステップ1     [必須] [1行]    [編集][×]  │ │
│ │ ≡ {step2}     ステップ2     [必須] [1行]    [編集][×]  │ │
│ │ ≡ {step3}     ステップ3     [必須] [1行]    [編集][×]  │ │
│ │ ≡ {tip}       ワンポイント  [任意] [複数行] [編集][×]  │ │
│ │                                                         │ │
│ │ [+ 変数を追加]                                          │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─ テンプレート構造 ──────────────────────────────────────┐ │
│ │                                                         │ │
│ │ ┌─────────────────────────────────────────────────────┐ │ │
│ │ │📱 シニアからの質問                                   │ │ │
│ │ │「{question}」                                        │ │ │
│ │ │                                                      │ │ │
│ │ │💡 解決方法                                           │ │ │
│ │ │① {step1}                                            │ │ │
│ │ │② {step2}                                            │ │ │
│ │ │③ {step3}                                            │ │ │
│ │ │                                                      │ │ │
│ │ │✨ ワンポイント                                       │ │ │
│ │ │{tip}                                                 │ │ │
│ │ │                                                      │ │ │
│ │ │---                                                   │ │ │
│ │ │📍パソコン・スマホ ほほ笑みラボ（飯田市）              │ │ │
│ │ └─────────────────────────────────────────────────────┘ │ │
│ │                                                         │ │
│ │ 💡 利用可能な変数: {question}, {step1}, {step2},        │ │
│ │    {step3}, {tip}                                       │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─ プレビュー ────────────────────────────────────────────┐ │
│ │                                                         │ │
│ │ 📱 シニアからの質問                                     │ │
│ │ 「LINEの通知が来ない」                                  │ │
│ │                                                         │ │
│ │ 💡 解決方法                                             │ │
│ │ ① 設定を開く                                           │ │
│ │ ② 通知を選択                                           │ │
│ │ ③ ONにする                                             │ │
│ │                                                         │ │
│ │ ✨ ワンポイント                                         │ │
│ │ 通知を許可すると便利です                                │ │
│ │                                                         │ │
│ │ ---                                                     │ │
│ │ 📍パソコン・スマホ ほほ笑みラボ（飯田市）               │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│                              [キャンセル] [プレビュー] [保存] │
└─────────────────────────────────────────────────────────────┘
```

### 8.5 ハッシュタグ設定画面

```
┌─────────────────────────────────────────────────────────────┐
│ ⚙️ 設定 > #️⃣ ハッシュタグ設定                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ┌─ 必須ハッシュタグ ──────────────────────────────────────┐ │
│ │                                                         │ │
│ │ 毎回の投稿に必ず含めるハッシュタグを設定できます。       │ │
│ │ 最大4個まで設定可能です。                               │ │
│ │                                                         │ │
│ │ ┌───────────────────────────────────────────────────┐  │ │
│ │ │ #ほほ笑みラボ                              [× 削除]│  │ │
│ │ │ #飯田市                                    [× 削除]│  │ │
│ │ │ #パソコン教室                              [× 削除]│  │ │
│ │ │ #スマホ                                    [× 削除]│  │ │
│ │ └───────────────────────────────────────────────────┘  │ │
│ │                                                         │ │
│ │ [+ ハッシュタグを追加]  (残り0個追加可能)               │ │
│ │                                                         │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─ 生成されるハッシュタグ ────────────────────────────────┐ │
│ │                                                         │ │
│ │ 📊 合計: 10個（必須4個 + 自動生成6個）                  │ │
│ │                                                         │ │
│ │ 必須ハッシュタグの数に応じて、AIが残りのハッシュタグを  │ │
│ │ 自動生成します。                                        │ │
│ │                                                         │ │
│ │ 必須0個 → 自動生成10個                                  │ │
│ │ 必須1個 → 自動生成9個                                   │ │
│ │ 必須2個 → 自動生成8個                                   │ │
│ │ 必須3個 → 自動生成7個                                   │ │
│ │ 必須4個 → 自動生成6個                                   │ │
│ │                                                         │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│                                                    [保存]   │
└─────────────────────────────────────────────────────────────┘
```

### 8.6 投稿作成画面の変更

#### Step 1: タイプ選択

DBから取得した投稿タイプを表示。有効な投稿タイプのみ表示。

```
┌─────────────────────────────────────────────────────────────┐
│ Step 1: 投稿タイプを選択                                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│ │     🔧      │ │     📢      │ │     💡      │            │
│ │  解決タイプ  │ │  宣伝タイプ  │ │ AI活用タイプ │            │
│ └─────────────┘ └─────────────┘ └─────────────┘            │
│                                                             │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│ │     ✨      │ │     📚      │ │     📖      │            │
│ │  実績タイプ  │ │ お役立ち    │ │  使い方     │            │
│ │             │ │  タイプ     │ │  タイプ     │            │
│ └─────────────┘ └─────────────┘ └─────────────┘            │
│                                                             │
│ ┌─────────────┐                                            │
│ │     🖼️      │                                            │
│ │ 画像読み取り │                                            │
│ └─────────────┘                                            │
│                                                             │
│ 💡 投稿タイプは設定画面でカスタマイズできます                 │
└─────────────────────────────────────────────────────────────┘
```

#### Step 2: 内容入力

選択した投稿タイプのプレースホルダー変数に基づいて、動的に入力フォームを生成。

---

## 9. 絵文字ピッカー

### 9.1 概要

投稿タイプのアイコン選択用に、絵文字ピッカーを実装する。

### 9.2 カテゴリ別絵文字リスト

| カテゴリ           | 絵文字         |
| ------------------ | -------------- |
| 一般               | 📝 📄 📋 📌 📍 |
| ツール             | 🔧 🔨 🛠️ ⚙️ 🔩 |
| 情報               | 💡 ❓ ❗ ℹ️ 📢 |
| 成果               | ✨ ⭐ 🌟 💫 🏆 |
| 教育               | 📚 📖 📕 📗 📘 |
| テクノロジー       | 💻 🖥️ 📱 🤖 🔌 |
| コミュニケーション | 💬 💭 🗣️ 📣 📩 |
| 画像               | 🖼️ 📷 📸 🎨 🖌️ |
| 矢印               | ➡️ ⬆️ ⬇️ ↗️ ↘️ |
| その他             | ✅ ❌ ⚠️ 🔔 🎯 |

### 9.3 ピッカーUI

```
┌─────────────────────────────────────────┐
│ アイコンを選択                          │
├─────────────────────────────────────────┤
│ [一般][ツール][情報][成果][教育]...     │
├─────────────────────────────────────────┤
│ 📝 📄 📋 📌 📍                          │
│ 🔧 🔨 🛠️ ⚙️ 🔩                          │
│ 💡 ❓ ❗ ℹ️ 📢                          │
│ ...                                     │
└─────────────────────────────────────────┘
```

---

## 10. 技術仕様

### 10.1 型定義

```typescript
// src/types/post-type.ts

export interface Placeholder {
  name: string;
  label: string;
  description?: string;
  required: boolean;
  inputType: 'text' | 'textarea';
}

export interface PostType {
  id: string;
  userId: string;
  name: string;
  slug: string;
  description: string;
  icon: string;
  templateStructure: string;
  placeholders: Placeholder[];
  minLength: number;
  maxLength: number;
  sortOrder: number;
  isActive: boolean;
  createdAt: string;
  updatedAt: string;
}

export interface PostTypeFormData {
  name: string;
  slug?: string;
  description?: string;
  icon: string;
  templateStructure: string;
  placeholders: Placeholder[];
  minLength: number;
  maxLength: number;
  isActive: boolean;
}
```

```typescript
// src/types/user-settings.ts

export interface UserSettings {
  id: string;
  userId: string;
  requiredHashtags: string[];
  settings: Record<string, unknown>;
  createdAt: string;
  updatedAt: string;
}
```

### 10.2 フォルダ構造（新規追加）

```
src/
├── app/
│   └── (dashboard)/
│       └── settings/
│           ├── page.tsx                 # 設定トップ（リダイレクト）
│           ├── post-types/
│           │   ├── page.tsx             # 投稿タイプ一覧
│           │   ├── new/page.tsx         # 新規作成
│           │   └── [id]/page.tsx        # 編集
│           └── hashtags/
│               └── page.tsx             # ハッシュタグ設定
│
├── components/
│   └── settings/
│       ├── post-type-list.tsx           # 投稿タイプ一覧
│       ├── post-type-form.tsx           # 投稿タイプフォーム
│       ├── placeholder-editor.tsx       # プレースホルダー編集
│       ├── template-editor.tsx          # テンプレート編集
│       ├── emoji-picker.tsx             # 絵文字ピッカー
│       └── hashtag-settings.tsx         # ハッシュタグ設定
│
├── hooks/
│   ├── usePostTypes.ts                  # 投稿タイプ取得・操作
│   └── useUserSettings.ts               # ユーザー設定取得・操作
│
└── types/
    ├── post-type.ts                     # 投稿タイプ型定義
    └── user-settings.ts                 # ユーザー設定型定義
```

---

## 11. 開発スケジュール（案）

| フェーズ | 内容                                  | 期間目安    |
| -------- | ------------------------------------- | ----------- |
| 1        | DBテーブル設計・作成                  | 1日         |
| 2        | データ移行スクリプト作成・実行        | 1日         |
| 3        | 投稿タイプAPI実装                     | 2日         |
| 4        | ユーザー設定API実装                   | 1日         |
| 5        | 投稿タイプ一覧・編集UI                | 3日         |
| 6        | ハッシュタグ設定UI                    | 1日         |
| 7        | 既存機能との統合（投稿作成・生成API） | 2日         |
| 8        | テスト・デバッグ                      | 2日         |
| **合計** |                                       | **約2週間** |

---

## 12. テスト観点

### 12.1 投稿タイプ

| テスト項目       | 確認内容                               |
| ---------------- | -------------------------------------- |
| 一覧表示         | 全投稿タイプが表示される               |
| 新規作成         | 正常に作成できる、上限10個で制限される |
| 編集             | 全項目が正常に更新される               |
| 削除             | 削除確認、使用中の投稿への影響         |
| 複製             | 正常にコピーされる                     |
| 並び替え         | ドラッグ&ドロップで順序変更            |
| 投稿作成連携     | 投稿作成時に正しいタイプが表示される   |
| キャプション生成 | テンプレートに基づいて正しく生成される |

### 12.2 必須ハッシュタグ

| テスト項目 | 確認内容                         |
| ---------- | -------------------------------- |
| 設定表示   | 現在の設定が正しく表示される     |
| 追加       | 新しいハッシュタグを追加できる   |
| 削除       | ハッシュタグを削除できる         |
| 上限       | 4個を超えて追加できない          |
| 生成連携   | 必須数に応じて生成数が調整される |

### 12.3 データ移行

| テスト項目   | 確認内容                           |
| ------------ | ---------------------------------- |
| 既存投稿     | 全投稿がpost_type_idと紐付いている |
| 投稿タイプ   | 7タイプが正しくDBに入っている      |
| 履歴表示     | 移行後も履歴が正常に表示される     |
| ロールバック | 問題発生時にロールバックできる     |

---

## 13. 将来の拡張（Phase 4に向けて）

### 13.1 複数ユーザー対応

Phase 4では以下の拡張を想定：

- 新規ユーザー登録時に、システムテンプレートをコピーして初期設定
- ユーザーごとに独立した投稿タイプ・設定を保持
- 管理者用のシステムテンプレート管理機能

### 13.2 画像スタイルのカスタマイズ

運用状況を見ながら、将来的に以下を検討：

- 画像スタイルのDB管理
- ベースプロンプトのカスタマイズ
- 新しいスタイルの追加

---

## 14. 更新履歴

| 日付       | 内容     | 担当   |
| ---------- | -------- | ------ |
| 2026-02-09 | 初版作成 | Claude |

---

## 15. 承認

| 役割                 | 氏名 | 日付 | 署名 |
| -------------------- | ---- | ---- | ---- |
| プロジェクトオーナー |      |      |      |
| 開発担当             |      |      |      |
