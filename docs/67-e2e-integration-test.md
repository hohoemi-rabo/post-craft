# チケット #67: E2E統合テスト + デモシナリオ検証

> Phase 4C | 優先度: 中 | 依存: #65, #66

## 概要

Phase 4 全体の E2E 統合テストを実施する。SPEC-PHASE4.md Section 12 の和菓子屋デモシナリオに沿って、Instagram 分析 → ブログ分析 → プロフィール・投稿タイプ自動生成 → 既存投稿作成フローとの統合を通しで検証する。サンプルデータの準備、手動テスト手順の文書化、各フローのエラーハンドリングの確認を含む。

## 対象ファイル

| ファイル | 操作 |
|---------|------|
| `docs/sample-data/wagashi-instagram.csv` | 新規作成（サンプルデータ） |
| 各コンポーネント・APIファイル | 不具合があれば修正 |

## 変更内容

### 1. サンプルデータの準備

#### Instagram サンプルCSV

`docs/sample-data/wagashi-instagram.csv` - Bright Data 形式のサンプルデータ:

```csv
post_id,post_type,caption,hashtags,likes_count,comments_count,posted_at,engagement_rate
"post001","image","【桜もち始めました】\n\n今年も春の訪れを告げる桜もちが登場しました🌸\n\n国産の桜葉を使用した、香り高い一品。\nもちもちの生地と上品なこしあんが絶妙です。\n\nぜひ店頭でお求めください。\n\n#和菓子 #桜もち #春の和菓子 #飯田市","和菓子,桜もち,春の和菓子,飯田市","245","18","2025-03-15T10:00:00Z","3.2"
"post002","image","【職人の手仕事】\n\n練り切りの制作過程をご紹介✨\n\n一つひとつ丁寧に形を整えていきます。\n季節の花をモチーフに、色付けにもこだわっています。\n\n#和菓子 #練り切り #職人技 #手仕事","和菓子,練り切り,職人技,手仕事","312","25","2025-03-10T12:00:00Z","4.1"
"post003","carousel","【お客様の声】\n\n先日ご購入いただいたお客様から\n嬉しいメッセージをいただきました💕\n\n「おばあちゃんへの贈り物に。\nとても喜んでもらえました」\n\n#和菓子 #贈り物 #お客様の声 #飯田市","和菓子,贈り物,お客様の声,飯田市","189","12","2025-03-08T15:00:00Z","2.5"
```

（20〜30行のサンプルデータを用意。商品紹介、製造工程、お客様の声、季節情報の4カテゴリをバランスよく含める）

### 2. テストシナリオ

#### シナリオ 1: Instagram分析フロー

| ステップ | 操作 | 期待結果 |
|---------|------|---------|
| 1-1 | `/analysis` にアクセス | 分析ダッシュボードが表示される |
| 1-2 | 「新規分析」をクリック | 分析ウィザードが表示される |
| 1-3 | 「Instagram」を選択 | データ入力画面に遷移 |
| 1-4 | CSVファイルをアップロード | ファイルが解析され、投稿数が表示される |
| 1-5 | アカウント名を入力 | 表示名が設定される |
| 1-6 | 「分析を開始」をクリック | プログレスバーが表示される |
| 1-7 | 分析完了を待つ | 分析結果ページに遷移 |
| 1-8 | 分析結果を確認 | 4要素（投稿タイプ傾向、トーン・文体、ハッシュタグ戦略、投稿パターン）が表示される |

#### シナリオ 2: ブログ分析フロー

| ステップ | 操作 | 期待結果 |
|---------|------|---------|
| 2-1 | 「新規分析」→「ブログ」を選択 | ブログURL入力画面に遷移 |
| 2-2 | テスト用ブログURLを入力 | URLが受け付けられる |
| 2-3 | 「分析を開始」をクリック | バックグラウンド処理が開始される |
| 2-4 | 分析完了を待つ | 分析結果ページに遷移 |
| 2-5 | 分析結果を確認 | コンテンツの強み、SNS転用可能ネタ、プロフィール素材が表示される |

#### シナリオ 3: 生成フロー

| ステップ | 操作 | 期待結果 |
|---------|------|---------|
| 3-1 | 分析結果ページで「テンプレートを生成」をクリック | 生成プレビューページに遷移 |
| 3-2 | 「生成を開始」をクリック | ローディング表示後、プレビューが表示される |
| 3-3 | プロフィールプレビューを確認 | アイコン、名前、説明、ハッシュタグ、システムプロンプトが表示 |
| 3-4 | 投稿タイプカードを展開 | テンプレート構造、プレースホルダー、type_prompt が表示 |
| 3-5 | 「編集してから適用」をクリック | 編集モードに切り替わる |
| 3-6 | プロフィール名を編集 | リアルタイムで反映される |
| 3-7 | 必須ハッシュタグを追加/削除 | タグの増減が反映される |
| 3-8 | 投稿タイプのテンプレートを編集 | リアルタイムで反映される |
| 3-9 | 「編集を適用する」→「適用する」をクリック | 適用成功画面が表示される |

#### シナリオ 4: 既存機能との統合

| ステップ | 操作 | 期待結果 |
|---------|------|---------|
| 4-1 | `/settings/profiles` にアクセス | 自動生成されたプロフィールが一覧に表示される |
| 4-2 | 生成されたプロフィールをクリック | プロフィール詳細が表示される（`source_analysis_id` が設定されている） |
| 4-3 | `/settings/post-types` にアクセス | 自動生成された投稿タイプが一覧に表示される |
| 4-4 | `/create` にアクセス | タイプ選択で自動生成された投稿タイプが表示される |
| 4-5 | 自動生成された投稿タイプを選択 | 対応するプロフィールのフィルターが適用される |
| 4-6 | メモを入力して投稿を作成 | 自動生成されたシステムプロンプトが使用されたキャプションが生成される |
| 4-7 | 生成されたキャプションを確認 | プロフィールのトーン・スタイルが反映されている |

#### シナリオ 5: エラーハンドリング

| ケース | 操作 | 期待結果 |
|-------|------|---------|
| 不正なCSV | ヘッダーが異なるCSVをアップロード | エラーメッセージが表示される |
| 空のCSV | ヘッダーのみのCSVをアップロード | 「投稿データがありません」エラー |
| 到達不能URL | 存在しないブログURLを入力 | タイムアウト後にエラーメッセージ |
| AI分析失敗 | （シミュレーション）APIキーなし | 適切なエラーメッセージが表示される |
| 適用の重複 | 同じ分析から2回適用 | 2つ目のプロフィールが作成される or 適用済みメッセージ |

### 3. デモシナリオ完全ウォークスルー（SPEC Section 12）

SPEC-PHASE4.md Section 12 に基づく6ステップのデモシナリオ:

```
Step 1: 導入（1分）
  - ダッシュボードを表示
  - 「飯田市の和菓子店さんがInstagramを始めたい」と説明

Step 2: 競合分析（2分）
  - `/analysis/new` に遷移
  - 事前に用意した wagashi-instagram.csv をアップロード
  - 分析実行 → 4要素レポート表示
  - 「都会の成功店はこういうパターンで成果を出しています」

Step 3: ブログ分析（1分）
  - 同じウィザードでブログ分析を追加実行
  - 記事取得 → AI分析 → 強み表示
  - 「この店の強みは季節の素材へのこだわりです」

Step 4: 自動生成（2分）
  - 「テンプレートを生成」をクリック
  - プロフィール + 投稿タイプがプレビュー表示
  - 「承認して適用」→ 完了
  - 「競合の成功パターン × 自分の強みで最適なテンプレートが完成」

Step 5: 投稿作成（1分）
  - `/create` に遷移（生成されたプロフィールが選択された状態）
  - メモ入力（例: 「春の新作桜もちを始めました」）
  - キャプション自動生成 → 完成
  - 「あとはメモを書くだけ。AIが全部やってくれます」

Step 6: まとめ（1分）
  - 全体のフローを振り返り
  - 「分析はできる。でもそこからどうすればいいか分からない。PostCraftはその間を埋めます」
```

### 4. 検証チェックリスト

#### パフォーマンス

| 処理 | 目標 | 実測 |
|------|------|------|
| CSVアップロード + パース | 5秒以内 | TBD |
| Instagram AI分析 | 30秒以内 | TBD |
| ブログ記事取得（〜100記事） | 300秒以内 | TBD |
| ブログ AI分析 | 30秒以内 | TBD |
| プロフィール + テンプレート生成 | 20秒以内 | TBD |
| 適用処理（DB保存） | 3秒以内 | TBD |

#### UI/UX

- [ ] 全ページでレスポンシブデザインが機能する
- [ ] ローディング・プログレス表示が適切
- [ ] エラーメッセージが分かりやすい
- [ ] ナビゲーション（サイドバー、戻るボタン）が正常
- [ ] トースト通知が適切なタイミングで表示される

#### データ整合性

- [ ] 生成されたプロフィールが `profiles` テーブルに正しく保存される
- [ ] 生成された投稿タイプが `post_types` テーブルに正しく保存される
- [ ] `profile_id` の紐付けが正しい
- [ ] `source_analysis_id` が正しく設定されている
- [ ] `generated_configs` のステータスが正しく更新される
- [ ] 既存のプロフィール・投稿タイプに影響がない

#### セキュリティ

- [ ] 未認証ユーザーがアクセスできない
- [ ] 他ユーザーの分析データにアクセスできない
- [ ] RLS ポリシーが正しく機能している

## 受入条件

- サンプルデータ（`wagashi-instagram.csv`）が用意されている
- シナリオ 1〜5 の全ステップが正常に動作する
- デモシナリオ（Step 1〜6）が一通り実行できる
- パフォーマンス目標値を満たしている
- エラーハンドリングが適切に機能する
- 生成されたプロフィール・投稿タイプが既存の投稿作成フローで使用できる
- データ整合性チェックが全て合格する
- 発見された不具合が修正されている
- `npm run build` が成功する

## TODO

- [ ] `docs/sample-data/wagashi-instagram.csv` を作成（20〜30行のサンプルデータ）
- [ ] シナリオ 1（Instagram分析フロー）を実行・検証
- [ ] シナリオ 2（ブログ分析フロー）を実行・検証
- [ ] シナリオ 3（生成フロー）を実行・検証
- [ ] シナリオ 4（既存機能との統合）を実行・検証
- [ ] シナリオ 5（エラーハンドリング）を実行・検証
- [ ] デモシナリオ（Step 1〜6）をウォークスルー
- [ ] パフォーマンス計測を実施
- [ ] UI/UX チェックリストを確認
- [ ] データ整合性チェックリストを確認
- [ ] セキュリティチェックリストを確認
- [ ] 発見された不具合を修正
- [ ] `npm run build` 成功を確認
