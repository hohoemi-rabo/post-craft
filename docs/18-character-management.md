# チケット #18: キャラクター管理

> Phase 2 キャラクター機能
> 優先度: 中
> 参照: SPEC-PHASE2.md セクション 4.5, 6.2

---

## 概要

画像生成に使用するオリジナルキャラクターを管理する機能を実装する。
画像アップロードによる特徴自動抽出、または手動での特徴入力に対応する。

---

## 機能概要

```
[キャラクター管理]
    │
    ├── キャラクター一覧表示
    ├── キャラクター新規登録
    │       ├── 画像アップロード → AI特徴抽出
    │       └── 手動特徴入力
    ├── キャラクター編集
    ├── キャラクター削除
    └── デフォルトキャラクター設定
```

---

## タスク一覧

### 1. キャラクター一覧ページ
- [x] `/app/(dashboard)/characters/page.tsx` 作成
- [x] キャラクターカード表示
  - サムネイル画像
  - キャラクター名
  - 特徴テキスト（抜粋）
  - デフォルトマーク
- [x] 新規登録ボタン
- [x] 編集・削除アクション

### 2. キャラクター登録モーダル/ページ
- [x] `components/characters/character-form.tsx` 作成
- [x] 入力項目
  - キャラクター名（必須）
  - 画像アップロード（任意）
  - 特徴テキスト（必須、画像からの自動生成 or 手動入力）
  - デフォルト設定（チェックボックス）

### 3. 画像アップロード機能
- [x] `components/characters/image-uploader.tsx` 作成
- [x] ドラッグ&ドロップ対応
- [x] プレビュー表示
- [x] ファイルサイズ制限（5MB）
- [x] 対応形式：PNG, JPG, WEBP
- [x] Supabase Storage へのアップロード

### 4. AI 特徴抽出 API
- [x] `/api/characters/analyze/route.ts` 作成
- [x] Gemini Vision API で画像分析
  ```typescript
  const analyzePrompt = `
  この画像のキャラクター/人物の特徴を分析してください。

  以下の項目を抽出してJSON形式で出力してください：
  - age: 年代（例: 30-40代）
  - gender: 性別
  - hair: 髪型・髪色
  - clothing: 服装
  - expression: 表情
  - style: イラストスタイル
  - other: その他の特徴（配列）

  また、画像生成プロンプトに使用できる
  description（特徴を1-2文で要約）も出力してください。
  `;
  ```

- [x] レスポンス形式
  ```typescript
  interface AnalyzeResponse {
    description: string;
    attributes: {
      age: string;
      gender: string;
      hair: string;
      clothing: string;
      expression: string;
      style: string;
      other: string[];
    };
  }
  ```

### 5. キャラクター CRUD API
- [x] `GET /api/characters` - 一覧取得
- [x] `POST /api/characters` - 新規登録
- [x] `PUT /api/characters/[id]` - 更新
- [x] `DELETE /api/characters/[id]` - 削除
- [x] 認証チェック（自分のキャラクターのみ操作可能）

### 6. Supabase Storage 連携
- [x] キャラクター画像のアップロード
  ```typescript
  const { data, error } = await supabase.storage
    .from('characters')
    .upload(`${userId}/${fileName}`, file);
  ```
- [x] 公開 URL 取得
- [x] 画像削除（キャラクター削除時）

### 7. デフォルトキャラクター機能
- [x] ユーザーごとに1つデフォルト設定可能
- [x] デフォルト設定時、他のキャラクターの is_default を false に
- [x] 投稿作成時にデフォルトキャラクターを初期選択

### 8. バリデーション
- [x] キャラクター名：1-50文字
- [x] 特徴テキスト：10-500文字
- [x] 画像：5MB以下、PNG/JPG/WEBP

---

## UI 設計

### キャラクター一覧
```
┌─────────────────────────────────────────────┐
│  キャラクター管理           [+ 新規登録]      │
├─────────────────────────────────────────────┤
│                                             │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐    │
│  │  [img]  │  │  [img]  │  │   ＋   │    │
│  │ まさゆき │  │ サポート │  │  追加   │    │
│  │ ⭐デフォルト│  │         │  │        │    │
│  │ [編集][削除]│  │[編集][削除]│  │        │    │
│  └─────────┘  └─────────┘  └─────────┘    │
│                                             │
└─────────────────────────────────────────────┘
```

### キャラクター登録フォーム
```
┌─────────────────────────────────────────────┐
│  キャラクター登録                             │
├─────────────────────────────────────────────┤
│                                             │
│  キャラクター名 *                             │
│  ┌─────────────────────────────────────┐   │
│  │ まさゆき                             │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  キャラクター画像                             │
│  ┌─────────────────────────────────────┐   │
│  │     📷 クリックまたはドロップ          │   │
│  │        PNG, JPG, WEBP               │   │
│  │         最大 5MB                    │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  [🔍 画像から特徴を自動抽出]                  │
│                                             │
│  特徴テキスト *                              │
│  ┌─────────────────────────────────────┐   │
│  │ 30-40代男性、短髪で黒髪、             │   │
│  │ 紺色のスーツに白シャツ、               │   │
│  │ 親しみやすい笑顔、似顔絵イラスト風      │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  ☐ デフォルトに設定する                      │
│                                             │
│  [キャンセル]              [保存]            │
└─────────────────────────────────────────────┘
```

---

## 完了条件

- [x] キャラクター一覧が表示される
- [x] キャラクターの新規登録ができる
- [x] 画像アップロードで特徴が自動抽出される
- [x] 手動で特徴テキストを入力できる
- [x] キャラクターの編集・削除ができる
- [x] デフォルトキャラクターを設定できる
- [x] 画像が Supabase Storage に保存される

---

## 技術メモ

### Gemini Vision API
```typescript
const model = genAI.getGenerativeModel({ model: 'gemini-2.5-flash-preview-05-20' });

const result = await model.generateContent([
  analyzePrompt,
  {
    inlineData: {
      mimeType: 'image/jpeg',
      data: base64Image,
    },
  },
]);
```

### Storage セキュリティ
- RLS でユーザーごとにアクセス制限
- ファイルパス: `{userId}/{timestamp}_{filename}`

---

## 依存関係

- #13 Supabase セットアップ
- #14 Google OAuth 認証
- #17 Gemini 文章生成（Gemini API 共通）

## 後続タスク

- #19 Gemini 画像生成（キャラクター使用）
- #21 投稿作成フロー（キャラクター選択）
