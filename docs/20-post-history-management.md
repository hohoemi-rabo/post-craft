# チケット #20: 投稿履歴管理

> Phase 2 履歴機能
> 優先度: 中
> 参照: SPEC-PHASE2.md セクション 6.2, 7, 8.1

---

## 概要

生成した投稿を保存し、履歴として閲覧・再利用できる機能を実装する。
投稿文、ハッシュタグ、生成画像を一元管理する。

---

## 機能概要

```
[投稿履歴]
    │
    ├── 投稿一覧表示（ページネーション）
    ├── 投稿詳細表示
    │       ├── 投稿文表示・コピー
    │       ├── ハッシュタグ表示・コピー
    │       ├── 画像表示・ダウンロード
    │       └── Instagram 起動
    ├── 投稿削除
    └── 投稿の再利用（テンプレートとして使用）
```

---

## タスク一覧

### 1. 投稿保存機能
- [x] 投稿生成完了時に自動保存
- [x] 保存データ
  ```typescript
  interface PostData {
    userId: string;
    postType: PostType;
    inputText: string;
    sourceUrl?: string;
    generatedCaption: string;
    generatedHashtags: string[];
  }
  ```
- [x] 画像保存との連携（post_images テーブル）

### 2. 投稿履歴一覧ページ
- [x] `/app/(dashboard)/history/page.tsx` 作成
- [x] 投稿カード表示
  - サムネイル画像（最初の画像）
  - 投稿タイプアイコン
  - キャプション抜粋（50文字）
  - 作成日時
- [x] ページネーション（10件/ページ）
- [x] 新しい順でソート

### 3. 投稿詳細ページ
- [x] `/app/(dashboard)/history/[id]/page.tsx` 作成
- [x] 表示項目
  - 投稿タイプ
  - 作成日時
  - 元のメモ/URL
  - 生成された投稿文（全文）
  - ハッシュタグ一覧
  - 生成画像一覧

### 4. 投稿履歴 API
- [x] `GET /api/posts` - 一覧取得
  ```typescript
  // Query params
  interface ListPostsParams {
    page?: number;      // default: 1
    limit?: number;     // default: 10
    postType?: PostType;
  }

  // Response
  interface ListPostsResponse {
    posts: Post[];
    total: number;
    page: number;
    totalPages: number;
  }
  ```

- [x] `GET /api/posts/[id]` - 詳細取得
  ```typescript
  interface GetPostResponse {
    post: Post;
    images: PostImage[];
  }
  ```

- [x] `DELETE /api/posts/[id]` - 削除
  - 関連する画像も Storage から削除

### 5. アクションボタン
- [x] キャプションコピーボタン
- [x] ハッシュタグコピーボタン
- [x] キャプション + ハッシュタグ一括コピー
- [x] 画像ダウンロードボタン
- [x] Instagram 起動ボタン
- [x] 削除ボタン（確認ダイアログ付き）

### 6. 投稿フィルタリング
- [x] 投稿タイプでフィルタ
- [ ] 日付範囲でフィルタ（任意）

### 7. 投稿の再利用
- [x] 「このテンプレートで新規作成」ボタン
- [x] 投稿タイプと入力テキストを引き継いで新規作成画面へ

### 8. 空状態の表示
- [x] 投稿がない場合のメッセージ
- [x] 新規作成への誘導

---

## UI 設計

### 投稿一覧
```
┌─────────────────────────────────────────────┐
│  投稿履歴                                    │
├─────────────────────────────────────────────┤
│                                             │
│  ┌────────────────────────────────────┐    │
│  │ [img] 🔧 解決タイプ    2026/01/24  │    │
│  │       LINEの通知が来ないって質問... │    │
│  │       [詳細] [削除]                │    │
│  └────────────────────────────────────┘    │
│                                             │
│  ┌────────────────────────────────────┐    │
│  │ [img] 📢 宣伝タイプ    2026/01/23  │    │
│  │       AI実務サポートで業務効率化... │    │
│  │       [詳細] [削除]                │    │
│  └────────────────────────────────────┘    │
│                                             │
│  [< 前へ]  1 / 5 ページ  [次へ >]           │
└─────────────────────────────────────────────┘
```

### 投稿詳細
```
┌─────────────────────────────────────────────┐
│  [← 戻る]  投稿詳細                          │
├─────────────────────────────────────────────┤
│                                             │
│  🔧 解決タイプ  |  2026/01/24 14:30         │
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │                                     │   │
│  │        [生成画像プレビュー]           │   │
│  │                                     │   │
│  └─────────────────────────────────────┘   │
│  [画像をダウンロード]                        │
│                                             │
│  ── 投稿文 ──────────────────────────       │
│  📱 シニアからの質問                         │
│  「LINEの通知が来ない」                      │
│  ...                                        │
│  [コピー]                                   │
│                                             │
│  ── ハッシュタグ ────────────────────       │
│  #パソコン教室 #シニア #LINE #通知設定 ...  │
│  [コピー]                                   │
│                                             │
│  [📋 すべてコピー] [📸 Instagram を開く]    │
│                                             │
│  ── アクション ──────────────────────       │
│  [🔄 このテンプレートで新規作成]             │
│  [🗑️ 削除]                                  │
└─────────────────────────────────────────────┘
```

---

## 完了条件

- [x] 生成した投稿が自動保存される
- [x] 投稿一覧が表示される
- [x] 投稿詳細が表示される
- [x] コピー機能が動作する
- [x] 画像ダウンロードが動作する
- [x] 投稿の削除ができる
- [x] ページネーションが動作する

---

## 技術メモ

### ページネーション
```typescript
// Supabase でのページネーション
const { data, error, count } = await supabase
  .from('posts')
  .select('*, post_images(*)', { count: 'exact' })
  .eq('user_id', userId)
  .order('created_at', { ascending: false })
  .range((page - 1) * limit, page * limit - 1);
```

### 画像の取得
- posts と post_images を JOIN して取得
- 最初の画像をサムネイルとして使用

---

## 依存関係

- #13 Supabase セットアップ
- #14 Google OAuth 認証
- #21 投稿作成フロー（保存トリガー）

## 後続タスク

- #22 Phase 2 統合テスト
